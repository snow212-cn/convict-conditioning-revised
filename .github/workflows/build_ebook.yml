name: æ„å»ºç”µå­ä¹¦å¹¶å‘å¸ƒ

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'revised_book_v2/**/*.md'
  workflow_dispatch:
    inputs:
      pdf_engine:
        description: 'PDFç”Ÿæˆå¼•æ“'
        required: true
        default: 'calibre'
        type: choice
        options:
          - calibre
          - pandoc
      pandoc_args:
        description: 'Pandocè‡ªå®šä¹‰å‚æ•° (ä¾‹å¦‚: --toc-depth=2)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å®‰è£…Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc
          pandoc --version
      
      - name: å®‰è£…ä¸­æ–‡å­—ä½“
        run: |
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          fc-cache -fv
          echo "âœ… ä¸­æ–‡å­—ä½“å®‰è£…å®Œæˆ"
          fc-list :lang=zh | head -5
      
      - name: å®‰è£…Calibre
        if: github.event.inputs.pdf_engine != 'pandoc'
        run: |
          sudo apt-get install -y calibre
          ebook-convert --version

      - name: å®‰è£…XeLaTeX (ç”¨äºPandoc PDF)
        if: github.event.inputs.pdf_engine == 'pandoc'
        run: |
          sudo apt-get install -y texlive-xetex texlive-fonts-recommended texlive-plain-generic
      
      - name: åˆå¹¶ç« èŠ‚æ–‡ä»¶
        run: |
          python scripts/merge_chapters.py
          echo "âœ… ç« èŠ‚åˆå¹¶å®Œæˆ"
          ls -lh Convict_Conditioning_Revised_Complete.md
      
      - name: ç”Ÿæˆç”µå­ä¹¦
        run: |
          python scripts/build_ebook.py --pdf-engine=${{ github.event.inputs.pdf_engine || 'calibre' }} --pandoc-args="${{ github.event.inputs.pandoc_args }}"
          echo "âœ… ç”µå­ä¹¦ç”Ÿæˆå®Œæˆ"
          ls -lh Convict_Conditioning_Revised_Complete.*
      
      - name: è·å–å½“å‰æ—¥æœŸå’Œæ—¶é—´
        id: date
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          echo "version=v$(date +'%Y.%m.%d')_${{ github.run_number }}" >> $GITHUB_OUTPUT
      
      - name: é…ç½®Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: æäº¤ç”Ÿæˆçš„æ–‡ä»¶
        run: |
          git add Convict_Conditioning_Revised_Complete.md
          git add Convict_Conditioning_Revised_Complete.epub
          git add Convict_Conditioning_Revised_Complete.pdf || true
          
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ¤– è‡ªåŠ¨æ„å»º: æ›´æ–°ç”µå­ä¹¦æ–‡ä»¶ (${{ steps.date.outputs.date }})"
            git push
            echo "âœ… æ–‡ä»¶å·²æäº¤å¹¶æ¨é€"
          fi
      
      - name: åˆ›å»ºRelease
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.date.outputs.version }}
          release_name: å›šå¾’å¥èº«ä¿®è®¢ç‰ˆ ${{ steps.date.outputs.version }}
          body: |
            ## ğŸ“š å›šå¾’å¥èº« - ç§‘å­¦ä¿®è®¢ç‰ˆ
            
            **å‘å¸ƒç‰ˆæœ¬**: ${{ steps.date.outputs.version }}
            **å‘å¸ƒæ—¥æœŸ**: ${{ steps.date.outputs.date }}
            
            ### ğŸ“¥ ä¸‹è½½
            
            - **EPUBæ ¼å¼**: é€‚ç”¨äºå¤§å¤šæ•°ç”µå­ä¹¦é˜…è¯»å™¨
            - **PDFæ ¼å¼**: é€‚ç”¨äºæ‰“å°å’Œç”µè„‘é˜…è¯»
            - **Markdownæ ¼å¼**: é€‚ç”¨äºåœ¨çº¿é˜…è¯»å’Œç¼–è¾‘
            
            ### ğŸ“ æ›´æ–°è¯´æ˜
            
            æœ¬ç‰ˆæœ¬åŸºäºæœ€æ–°çš„ç« èŠ‚ä¿®è®¢è‡ªåŠ¨æ„å»ºç”Ÿæˆã€‚
            
            ### âš ï¸ å…è´£å£°æ˜
            
            æœ¬ä¿®è®¢ç‰ˆæœ¬ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä¸å¾—ç”¨äºå•†ä¸šç”¨é€”ã€‚
            è®­ç»ƒå‰è¯·å’¨è¯¢ä¸“ä¸šåŒ»ç–—äººå‘˜æˆ–è®¤è¯æ•™ç»ƒã€‚
            
            ---
            
            **æ„å»ºæ—¶é—´**: ${{ steps.date.outputs.datetime }}
            **æ„å»ºç¼–å·**: ${{ github.run_number }}
          draft: false
          prerelease: false
      
      - name: ä¸Šä¼ EPUBåˆ°Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./Convict_Conditioning_Revised_Complete.epub
          asset_name: Convict_Conditioning_Revised_${{ steps.date.outputs.version }}.epub
          asset_content_type: application/epub+zip
      
      - name: ä¸Šä¼ PDFåˆ°Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./Convict_Conditioning_Revised_Complete.pdf
          asset_name: Convict_Conditioning_Revised_${{ steps.date.outputs.version }}.pdf
          asset_content_type: application/pdf
        continue-on-error: true
      
      - name: ä¸Šä¼ Markdownåˆ°Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./Convict_Conditioning_Revised_Complete.md
          asset_name: Convict_Conditioning_Revised_${{ steps.date.outputs.version }}.md
          asset_content_type: text/markdown
      
      - name: æ„å»ºå®Œæˆé€šçŸ¥
        run: |
          echo "================================================"
          echo "âœ… ç”µå­ä¹¦æ„å»ºå’Œå‘å¸ƒå®Œæˆï¼"
          echo "================================================"
          echo "ğŸ“¦ Releaseç‰ˆæœ¬: ${{ steps.date.outputs.version }}"
          echo "ğŸ”— Releaseé“¾æ¥: ${{ steps.create_release.outputs.html_url }}"
          echo "================================================"
